# Interacting with the frontend
The frontend interacts with the backend through a remote procedural call. In this tool, Pyodide remote procedural calls are managed by Social Finance's [prpc module](https://github.com/SocialFinanceDigitalLabs/prpc).

Functions that are accessible by the frontend exist in the `rpc_main.py` file. When run in the frontend, a reference to the file uploaded by the user is passed in as the cin_data argument. 
To test the functions from the command line interface, run commands of the form 
`prpc run -a <filename>: app <function_name>`

## Examples
The `generate_tables` function takes in a CIN xml file and generates it's constituent tables according to the DfE guidance. It can be tested by assigning the file path of the xml file to the cin_data parameter and running `prpc run -a rpc_main:app generate_tables`

In the same way, if the xml file path is assigned to the cin_data parameter of the cin_validate function, it's data can be generated by running `prpc run -a rpc_main:app cin_validate` in the command line.

Note that the objects returned by all prpc functions need to be in json format. 

# Features
This tool has two main functions: convert CIN XML into tables and run CIN validation rules on CIN data.

## Conversion: generate_tables
Data conversion is handled by the `generate_tables` function in `rpc_main.py`. It is an optional step for users who want their data converted but would not like to go through the validation process.
The `generate_tables` function returns a dictionary of dataframes that has been converted to json format. The key-value pairs are the table names and their corresponding data content.

The result of this function can be used in the display of issue locations to show exactly what values were flagged by the rules. Also, if the user decides to download CSVs, the tables in the result of the function should be converted to CSV and provided to the user.

It should be noted that all date columns in the tabular data is converted to datetime format during the conversion process.

These are all the possible tables. They will not always all be present.
1. Header
2. ChildIdentifiers
3. ChildCharacteristics
4. Disabilities
5. CINdetails
6. Assessments
7. CINplanDates
8. Section47
9. ChildProtectionPlans
10. Reviews

The Header contains the metadata including collection_year and census type. If CSV input is received, the Header file must be uploaded and all uploaded files must contain an `LAchildID`.

## Validation: cin_validate
This is the default feature. File input is converted into tabular-format (dataframes) and the data is validated based on rules [defined by the DfE](https://www.gov.uk/government/publications/children-in-need-census-2022-to-2023-specification) and coded in the `rules` folder.

The `cin_validate` function receives three arguments: a reference to the xml file that needs to be validated, an optional choice of rules, and an optional choice of which rule pack to run. The third parameter (ruleset) will only need to be changed if the user choses to validate their data based on the rules of a year different from the one they're in.

When the `ruleset` is not specified, the internal `create_registry` function will run the latest ruleset in the repo. For now, the frontend (rpc_main) and cli (cin_validator.main) handlers have been hardcoded to default to the "cin2022_23" ruleset. As such, the behaviour is predictable. This hardcoding needs to be updated each year when there is a new default ruleset (e.g in the year 2024/2025, the ruleset default argument should be updated to "cin2024_24")

The `selected_rules` parameter works with a single string or an array (list/tuple) of strings where each value is a rule code that the user chose to run in the frontend.

The validation process returns an issue report, rule definitions of only the rules that triggered issues, and a tabular format of the CIN data it received.

The issue report outlines the specific (table-column-row) locations of the data (tabular data returned by the generate_tables function) that failed the validation and should be flagged in the frontend.
Each row in the issue report contains the code of the rule that flagged the issue such that the issue report can be linked to the rule definitions, allowing the user highlight the related rule description by clicking on a flagged error location. 

### The issue report
Each row in the issue report specifies a location where the data failed a validation rule. The main columns are the those that specify the table, column and row of the issue.
There are three types of issue locations based on how they appear in the issue report.
- linked issues
- singular issues.
- local authority level issues

Local authority level issues have only a rule code and description. They might not appear in the issue-report but will appear in the `rule_defs` object(which contains the descriptions of the rules that failed). These are rules that check the local authority as a whole and are not linked to a specific location in the data (for example [1520](https://github.com/data-to-insight/CIN-validator/issues/9)). They should be displayed in a different font color.

Singular issues have values for table, column and row affected but no value in the `error_id` column. Each flagged location here is independent from all others (for example [8500](https://github.com/data-to-insight/CIN-validator/issues/9))

Linked issues are the only issues that have a value in the `error_id` column. All issue locations that have the same error_id value should be highlighted together in the frontend. These are issues flagged by rules that check the relationship between multiple values in the data (for example [8606](https://github.com/data-to-insight/CIN-validator/issues/35))

